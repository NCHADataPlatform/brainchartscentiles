---
title: "BrainChart calibration tutorial"
format: html
---

```{r, echo=FALSE}
knitr::read_chunk("calibration_example_hbn.R")
```

# Introduction

The code in this repository extends the original BrainChart codebase, and
therefore can't be assembled into a standard R package without restructuring 
that code.

First, load the libraries we'll be using later:

```{r Packages, echo=TRUE, message=FALSE, warning=FALSE}
```


The functionality in this repository is accessed via the following code snippet.

```{r Setup, message = FALSE, warning = FALSE}
```

__IMPORTANT NOTE__ A full path to `calibrate_braincharts_centiles.R` must be provided 
if your code is outside this repository. e.g.

```{r, eval=FALSE}
BrainChartFolder <- dirname(normalizePath("~/Projects/brainchartscentiles/calibrate_braincharts_centiles.R"))
source(file.path(BrainChartFolder, 'calibrate_braincharts_centiles.R'))
```



Using the calibration functions requires the following steps:

1. Loading brain IDPs
1. Attaching demographic and site data
1. Renaming columns
1. Calibrating the large population sample
1. Calibrate the small population sample with repeated measures in the large 
   population sample
   
This tutorial illustrates calibration using a combination of data from the healthy
brain network and synthetic data. The code can be used as a template to
calibrate your own data.

Note that some output from the code snippets has been supressed to make cleaner
documentation. The code used to create this tutorial is available in the file
`calibration_example_hbn.R`.

# Loading FreeSurfer and demographic data

## Helper function and loading FreeSurfer data

First load the study FreeSurfer data. These tables are collated from the individual 
study statistics using the FreeSurfer `asegstats2table` and `aparcstats2table`
utilities, as illustrated in the bash script named `freesurfer_make_stats.sh`.

```{r LoadingStructuralData, message=FALSE}
```

## Set up IDP columns

Next, we select columns of interest and combine and rename them as required by the
BrainChart calibration process. We then join the per-hemisphere surface-based
metrics to the volume metrics and optionally discard columns not required by 
calibration.

```{r MakeIDPColumns}
```

## Set up other required columns

Here, we make the columns `fs_version` (the version of FreeSurfer used for processing), `run` (an identifier for the acquisition session), `participant` (the subject IDs), `country` (acquisition country, *unused*).

```{r MakeOtherColumns}

```

## Set up the study column

The `study` column contains the identifier for the sample each set of measurements belongs to. It can be an arbitrary string, and all measurements belonging to the same sample must have the same value. It cannot be one of the studies in the Braincharts' training set, which are as follows: 3R-BRAIN, ABCD, abide1, abide2, ADHD200, ADNI, AIBL, AOBA, AOMIC_ID1000, AOMIC_PIOP1, AOMIC_PIOP2, ARWIBO, BabyConnectome, BGSP, BHRCS, BSNIP, Calgary, CALM, CamCAN, CAMFT, Cornell_C1, Cornell_C2, cVEDA, devCCNP, dHCP, DLBS, EDSD, EMBARC, FemaleASD, FinnBrain, GUSTO, HABS, Harvard_Fetal1, HBN, HCP, HCP_lifespanA, HCP_lifespanD, IBIS, ICBM, IMAGEN, IMAP, IXI, LA5c, MCIC, Narratives, NHGRI, NIH, NIHPD, NSPN, NTB_Yale, OASIS3, Oulu, PCDC, PING, PNC, POND, PREVENTAD,  RDB, SALD, SLIM, UCSD, UKB, VETSA, WAYNE.

In this example, we set the study column later via the demographic data.

## Set up the diagnosis/group column

The `dx` column assigns participants to control `CN` (for calibration) or other `notCN` (not for calibration). Here, all subjects are controls, so we set it as follows:

```{r MakeDXColumn}
```

Derived values, such as centiles, are estimated for non-controls, but these measurements are not used for calibration.

## Prepare demographic information

Preparing the demographic information is similar. In the HBN dataset the
demographic tables are provided on a per-study basis, so we load them individually,
create a study column, combine into a single table, create an `age_days` column
and rename the `Sex` column and set up the factor levels. We set the `study` column according to the acquisition site (CBIC).

```{r LoadDemo}

```


## Combining IDP and demographic tables

Finally, we merge the demographic and IDP tables using the study ID as a key, and
exclude any incomplete records.

More complex studies may require merging by combinations of multiple columns,
such as ID and time point or site.

```{r JoinDemographics}
```

# Calibration

## Study overview

Perform a quick check of study numbers and breakdown by sex to ensure that
the data is correctly loaded

```{r StudyOverview}


```

## Calibration, Phase 1
Phase 1 of calibration is the standard, cross sectional, version proposed
in the original BrainCharts paper. We show cortical thickness as the IDP of interest. 
We perform this on a per-study basis, since each study represents a single sample.
We will illustrate usage with a single site (CBIC).

```{r CalibrationPhase1, warning=FALSE, echo=TRUE}
```

The fields of the results structure will be described later.

## Calibration, Phase 2
Phase 2 of calibration is the "small" sample calibration, which would typically
form part of the study dataset. We generate a simulated small sample in this
example.

```{r SimulateSmallSiteSetup, warning=FALSE, echo=FALSE}
```

```{r SimulateSmallSite, warning=FALSE}
```

Here, `subFakeDF` would represent the "small" sample an investigator is wishing to calibrate. We calibrate this sample using the centile-informed repeated measures method, using the large site calibration output previously computed as follows:

```{r CalibrationPhase2, warning=FALSE}
```

## Results

```{r ResultsPrint, warning=FALSE}
```

The results data structure will be described, this is purely for reference. In this example, we will use the `The dataframe *fullSampleCBICCalibration* is the output

- `fullSampleCalibration$expanded`: The model parameters 
    - `fullSampleCalibration$expanded$mu$ranef`: The $\mu$ site-effect estimates. The user-provided study name will be the estimated effect for the sample, in this example it is `fullSampleCalibration$expanded$mu$ranef[['HBN']]`
    - `fullSampleCalibration$expanded$sigma$ranef`: The $\mu$ site-effect estimates. The user-provided study name will be the estimated effect for the sample, in this example it is `fullSampleCalibration$expanded$mu$ranef[['HBN']]`
- `fullSampleCalibration$DATA.PRED`: The data with predicted values from the model *before* calibration
- `fullSampleCalibration$DATA.PRED2`: The data with predicted values for parameters *after* calibration
    - `fullSampleCalibration$DATA.PRED2$meanCT2transformed`: the transformed cortical thickness values
    - `fullSampleCalibration$DATA.PRED2$mu.pop`: the training data $\mu$
    - `fullSampleCalibration$DATA.PRED2$mu.wre`: the estimated $\mu$ for each measurement
    - `fullSampleCalibration$DATA.PRED2$sigma.pop`: the training data $\sigma$ for each measurement
    - `fullSampleCalibration$DATA.PRED2$sigma.wre`: the estimated $\sigma$ for each measurement
    - `fullSampleCalibration$DATA.PRED2$PRED.l250.pop`: the training data 0.25 centile for each measurement
    - `fullSampleCalibration$DATA.PRED2$PRED.m500.pop`: the training data 0.5 (median) centile for each measurement
    - `fullSampleCalibration$DATA.PRED2$PRED.u750.pop`: the training data 0.75 centile for each measurement
    - `fullSampleCalibration$DATA.PRED2$PRED.l250.wre`: the estimated 0.25 centile for each measurement
    - `fullSampleCalibration$DATA.PRED2$PRED.m500.wre`: the estimated 0.5 (median) centile for each measurement
    - `fullSampleCalibration$DATA.PRED2$PRED.u750.wre`: the estimated 0.75 centile for each measurement
    - `fullSampleCalibration$DATA.PRED2$meanCT2Transformed.q.wre`: the estimated centile of the cortical thickness measurement in the altered site-corrected distribution. These values are in a consistent frame between samples.

## Plotting results

This plot depicts a typical representation of the measured data and the estimated centile lines. The original data are plotted as points with the centile lines overlaid.

```{r MakePlots, warning=FALSE}
```
